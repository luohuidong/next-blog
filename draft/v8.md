---
title: "V8 工作原理"
category: "浏览器工作原理"
tag:
  [
    "V8",
    "JavaScript",
    "编译器",
    "解释器",
    "AST",
    "词法分析",
    "语法分析",
    "字节码",
    "热点代码",
  ]
---

了解 V8 的执行机制，能帮助我们从底层了解 JavaScript，也能帮助我们深入理解语言转换器 Babel、语法检查工具 ESList、前端框架 Vue 和 React 的一些底层实现机制。

要了解 V8 的工作原理，需要搞清楚一些概念和原理，如编译器（Compiler）、解释器（Interpreter）、抽象语法树（AST）、字节码（Bytecode）、即时编译器（JIT）等概念。

## 编译器和解释器

之所以存在编译器和解释器，是因为机器不能直接理解我们所写的代码，所以在执行程序之前，需要将我们所写的代码翻译成机器能读懂的机器语言。按照语言的执行流程，可以把语言划分为编译型语言和解释型语言。

编译型语言在程序执行之前，需要经过编译器的编译过程，并且编译之后会直接保留机器能读懂的二进制文件，这样每次运行程序时，都可以直接运行该二进制文件，而不需要再次重新编译了。比如 C/C++、GO 等都是编译型语言。

而由解释型语言编写的程序，在每次运行时都需要通过解释器对程序进行动态解释和执行。比如 Python、JavaScript 等都属于解释型语言。

### 编译型语言的编译过程

编译型语言的编译过程：

1. 词法分析
2. 语法分析
3. 语义分析
4. 生成中间代码
5. 优化代码
6. 生成目标代码

前三个过程主要的目的让编译器能够读懂程序，而后三个过程则是继续把程序编译成机器能够读懂的代码，并高效运行。

#### 词法分析（Lexical Analysis）

编译器的第一项工作叫做词法分析。就像阅读文章一样，文章是由一个个的中文单词组成。程序处理也一样，只不过这里不叫单词，而叫做 Token。

#### 语法分析（Syntactic Analysis）

词法分析是识别一个个单词，而语法分析就是在词法分析的基础上识别出程序的语法结构。这个结构是一个树状结构（抽象语法树，AST），是计算机容易理解和执行的。

语法分析过程，就是构造 AST，AST 的每个节点（子树）是一个语法单元，这个单元的构成规则就叫做“语法”。

#### 语义分析（Semantic Analysis）

当词法分析和语法分析做完之后，编译器接下来的工作就是语义分析。语义分析就是要让计算机理解我们的意图，根据上下文，把一些模棱两可的地方消除掉。

计算机中的语义一般可以表达为一些规则：

- 某个表达式的计算结果是什么数据类型。如果有数据类型不匹配的情况，是否需要做自动转换？
- 一个代码块的内部和外部都有相同名称的变量，在执行的时候到底用哪个？
- 在同一个作用域内，不允许有两个名称相同的变量，也就是唯一性检查
- ...

语义分析基本上就是做这些事情。

#### 目标代码

编译器的最终结果，就是生成目标代码。如果目标是在计算机上直接运行，就像 C 语言程序那样，那么这个目标代码指的是汇编代码。如果运行目标是 Java 虚拟机，那这个目标代码就是指 JVM 的字节码。

假设我们的目标代码是汇编代码，由于汇编代码关心 CPU 和内存这样具体的硬件，因此针对不同的硬件，生成的汇编代码是不同的。而一般语言在设计的时候都要支持尽可能多的硬件平台，那生成汇编代码的工作量就会很庞大了。

#### 中间代码

为了应对前面所说的工作量庞大的问题，降低工作量、提供软件复用度，因此引入了中间代码（Intermediate Representation，IR）的机制，它是独立于具体硬件的一种代码格式。

各个语言的前端可以先翻译成 IR，然后再从 IR 翻译成不同硬件架构的汇编代码。如果有 n 个前端语言，m 个后端架构，本来需要做 m\*n 个翻译程序，现在只需要 m+n 个了。这就大大降低了总体的工作量。

#### 代码分析和优化

然而是否真的就是中间代码就直接用来生成汇编代码了？并不是。

生成正确的、能够执行的代码比较简单，可这样的代码执行效率很低，因为直接翻译生成的代码往往不够简洁，比如会生成大量的临时变量，指令数量也较多。因为翻译程序首先照顾的是正确性，很难同时兼顾是否足够优化，这是一方面。

另一方面，由于高级语言本身的限制和程序员的编程习惯，也会导致代码不够优化，不能充分发挥计算机的性能。所以我们一定要对代码做优化。

### 解释型语言的解释过程

了解了前面编译型语言的编译过程，那么了解解释型语言的解释过程就容易多了。

解释型语言的解释过程：

1. 解释器会对源码进行词法分析、语法分析，生成抽象语法树（AST）。
2. 基于 AST 生成字节码。
3. 根据字节码来执行程序、输出结果。

## 参考资料

- [编译原理之美 —— 01 | 理解代码：编译器的前端技术](https://time.geekbang.org/column/article/118132)
