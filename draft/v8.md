---
title: "V8 工作原理"
category: "浏览器工作原理"
tag:
  [
    "V8",
    "JavaScript",
    "解释器",
    "AST",
    "词法分析",
    "语法分析",
    "字节码",
    "热点代码",
  ]
---

了解 V8 的执行机制，能帮助我们从底层了解 JavaScript，也能帮助我们深入理解语言转换器 Babel、语法检查工具 ESList、前端框架 Vue 和 React 的一些底层实现机制。要了解 V8 的工作原理，需要搞清楚一些概念和原理，如编译器（Compiler）、解释器（Interpreter）、抽象语法树（AST）、字节码（Bytecode）、即时编译器（JIT）等概念。

我们所使用的 JavaScript 是一种解释型的语言，在执行程序之前，是需要解释器对 JavaScript 代码进行解释的。之所以需要解释，是因为机器不能直接理解我们所写的代码，所以在执行程序之前，需要将我们所写的代码翻译成机器能读懂的机器语言。在 V8 执行 JavaScript 过程中，除了解释过程，其实也会涉及编译过程的。

这里稍微简单介绍一下编译型语言和解释型语言。编译型语言在程序执行之前，需要经过编译器的编译过程，并且编译之后会直接保留机器能读懂的二进制文件，这样每次运行程序时，都可以直接运行该二进制文件，而不需要再次重新编译了。而由解释型语言编写的程序，在每次运行时都需要通过解释器对程序进行动态解释和执行。

有了前面的铺垫，就可以开始了解 V8 是如何执行一段 JavaScript 代码了。下图是 V8 执行一段代码的流程图：

![20210207101830](http://images.luohuidong.cn/20210207101830.png)

我们都知道 JavaScript 是一种解释型语言，而有意思的是上面的流程图中，既有解释器，也有编译器。也就是说 V8 在执行代码的时候，既有解释过程，也有编译过程。

下面将分解 V8 的执行过程。

## 词法分析 —— 分词（tokenize）

解释过程的第一步是词法分析，它的作用就是将一行行的源代码拆解成一个个 token。所谓 token，指的是语法上不可能再分的、最小的单个字符或字符串。这个过程有点类似于我们阅读文章的时候，会将句子拆分成一个个词的过程。

```js
const foo = "bar";
```

关键字 `const`，标识符 `foo`，赋值运算符 `=`，字符串 `"bar"` 都是 token。

## 语法分析 —— 解析（parse）

词法分析是识别一个个的单词，而语法分析就是在词法分析的基础上识别出程序的语法结构。

语法分析过程，其实就是在构造一棵叫抽象语法树（AST）的东西。

### AST

高级语言对于开发者来说是可以理解的语言，但是让编译器或者解释器来理解就非常困难了。而对于编译器或者解释器来说，它们可以理解的就是 AST。这与渲染引擎将 HTML 格式文件转换为计算机可以理解的 DOM 树类似。

[JAVASCRIPT AST VISUALIZER](https://resources.jointjs.com/demos/javascript-ast) 展示了一段代码转换为为 AST 后的可视化结果。

从 AST 可以看出代码的层次结构，因此可以把 AST 看成代码的结构化表示。编译器或者解释器后续的工作都需要依赖于 AST 而不是源代码。

AST 是非常重要的一种数据结构，在很多项目中有着广泛的应用。其中最著名的一个项目是 Babel。Babel 是一个被广泛使用的代码转码器，可以将 ES6 代码转为 ES5 代码，这意味着你可以现在就用 ES6 编写程序，而不用担心现有环境是否支持 ES6。Babel 的工作原理就是先将 ES6 源码转换为 AST，然后再将 ES6 语法的 AST 转换为 ES5 语法的 AST，最后利用 ES5 的 AST 生成 JavaScript 源代码。

除了 Babel 外，还有 ESLint 也使用 AST。ESLint 是一个用来检查 JavaScript 编写规范的插件，其检测流程也是需要将源码转换为 AST，然后再利用 AST 来检查代码规范化的问题。

## 推荐阅读

- [浏览器工作原理与实践 —— 14 | 编译器和解释器：V8 是如何执行一段 JavaScript 代码的？](https://time.geekbang.org/column/article/131887)
- 执行上下文
  - [重学前端 —— JavaScript 执行（二）：闭包和执行上下文到底是怎么回事？](https://time.geekbang.org/column/article/83302)
  - [浏览器工作原理与实践]
  - [浏览器工作原理与实践 —— 08 | 调用栈：为什么 JavaScript 代码会出现栈溢出？](https://time.geekbang.org/column/article/120257)
  - [浏览器工作原理与实践 —— 11 | this：从 JavaScript 执行上下文的视角讲清楚 this](https://time.geekbang.org/column/article/128427)
- [编译原理之美 —— 01 | 理解代码：编译器的前端技术](https://time.geekbang.org/column/article/118132)
