---
title: "从输入 URL 到页面展示，中间发生了什么 —— 渲染阶段"
tag: ["浏览器工作原理", "渲染阶段"]
---

当导航完成之后，浏览器将进入渲染阶段。在渲染阶段会包含下面的步骤：

- 继续读取来自服务器的剩余响应数据
- 对响应数据进行解析
- 渲染文档以便用户可以看见
- 执行文档中附带的所有脚本
- 加载所有子资源

渲染阶段的目的就是将 HTML、CSS、JavaScript、图片等文件展示出来让用户可以看见。但是在渲染过程中，浏览器是做了很多东西的，由于渲染机制的复杂性，因此渲染流程会被划分为很多个子阶段，最后输出像素，这个过程就像流水线一样。

按照渲染的时间顺序，流水线可以分为如下几个子阶段：

1. 构建 DOM 树
2. 样式计算
3. 布局阶段
4. 分层
5. 绘制
6. 分块
7. 光栅化
8. 合成

每个阶段关注以下三点内容：

- 开始每个子阶段都有其**输入的内容**
- 每个子阶段有其**处理过程**
- 每个子阶段会生成**输出内容**

## 构建 DOM 树

构建 DOM 树阶段：

1. 输入内容：HTML
2. 处理过程：HTML 解析器解析 HTML
3. 输出内容：树状结构的 DOM 树

构建 DOM 树的阶段，输入的内容是 HTML，HTML 经过 HTML 解析器解析，最终输出树状结构的 DOM。之所以要构建 DOM 树，是因为浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为浏览器能够理解的结构 —— DOM 树。DOM 树是保存在内存中的树状结构，可以通过 JavaScript 来查询或修改其内容。

## 样式计算

样式计算阶段：

1. 输入内容：CSS
2. 处理过程：CSS 转换为 styleSheets、属性值标准化、计算出节点的具体样式。
3. 输出内容：ComputedStyle

前面生成了 DOM 树，但是 DOM 节点的样式仍然不知道，要让 DOM 节点拥有正确的样式，就需要样式计算。这个阶段大体可分为三步来完成：

1. 把 CSS 转换为浏览器能够理解的结构
2. 转换样式表中的属性值，使其标准化
3. 计算出 DOM 树中每个节点的具体样式

### 把 CSS 转换为浏览器能够理解的结构

CSS 样式的来源：

- 通过 link 引用的外部 CSS 文件
- `<style>` 标记内的 CSS
- 元素的 style 属性内嵌的 CSS

和 HTML 文件一样，浏览器也是无法直接理解这些纯文本的 CSS 样式，所以当渲染引擎接收到 CSS 文本时，会执行一个转换操作，将 CSS 文本转换为浏览器可以理解的结构 —— **styleSheets**。

styleSheets 的结构可以通过 `document.styleSheets` 来查看。

> 在 chromium 源码中已经没有 CSSOM 这个词了，它是一个过时的东西。

### 转换样式表中的属性值，使其标准化

当 CSS 文本转化为浏览器可以理解的结构之后，接下来就是要对其进行属性值的标准化操作。

要理解标准化，先看一段 CSS 文本：

```css
body {
  font-size: 2em;
}
p {
  color: blue;
}
span {
  display: none;
}
div {
  font-weight: bold;
}
div p {
  color: green;
}
div {
  color: red;
}
```

由于 `2em`、`blue`、`bold` 这些类型数值不容易被渲染引擎理解，所以需要将所有的值转换为渲染引擎容易理解的、标准化的计算值，这个过程就是属性值标准化。

标准化后的属性值会变成下面的样子：

```css
body {
  font-size: 32px;
}

p {
  color: rgb(0, 0, 255);
}

span {
  display: none;
}

div {
  font-weight: 700;
}
div p {
  color: green;
}
div {
  color: red;
}
```

### 计算出 DOM 树中每个节点的具体样式

当样式的属性被标准化后，接下来就需要计算 DOM 树中每个节点的样式属性。样式属性的计算涉及 CSS 的继承规则和层叠规则。

- 继承就是每个 DOM 节点都包含有父节点的样式
- 层叠，它是一个定义了如何合并来自多个源的属性值的算法。它在 CSS 处于核心地位，CSS 的全称“层叠样式表”正式强调了这一点。

样式计算阶段的目的是为了计算出 DOM 节点中每个元素的具体样式，在计算过程中需要遵守 CSS 的继承和层叠两个规则。这个阶段最终输出的内容是每个 DOM 节点的样式，并被保存在 ComputedStyle 的结构内。

## 布局阶段

布局阶段：

- 输入内容：DOM 和 ComputedStyle
- 处理过程：创建布局树、计算节点的坐标位置
- 输出内容：包含布局运算结构的布局树

有了 DOM 树和 DOM 树中的元素的样式，还不足以显示页面，因为此时不知道 DOM 元素的几何位置信息。接下来就是计算出 DOM 树中**可见**元素的几何位置，这个计算过程叫做布局。

在布局阶段浏览器要完成两个任务：创建布局树和布局计算。

### 创建布局树

DOM 树含有很多不可见的元素，比如 head 标签，还有使用了 `display:none` 属性的元素。因此在显示之前，还要额外地构建一颗**只包含可见元素的布局树**。

为了创建布局树，浏览器大体上完成了下面的工作：

- 遍历 DOM 树中的所有可见节点，并把这些节点添加到布局树中。
- 而不可见的节点会被布局树忽略掉，如 head 标签下面的全部内容，`display:none` 属性的元素。

### 布局计算

当有了一颗完整的布局树后，就要计算布局树节点的坐标位置。在执行布局操作的时候，会把布局运算的结果重新写回布局树中，所以布局树既是输入内容也是输出内容。

> 渲染树是 16 年之前的东西，chromium 源码中已经完全重构，我们可以把 LayoutTree 看成是渲染树，但是 LayoutTree 跟之前的渲染书还是有一些差别的。

## 分层

当获取完布局树之后，接下来的步骤就是进行分层。

### 图层树

由于页面中有很多复杂的效果，如一些复杂的 3D 变换、页面滚动，或者使用 z-indexing 做 z 轴排序等。为了更加方便地实现这些效果，渲染引擎需要为特定的节点生成专用的图层，并生成一颗对应的图层树（LayerTree）。这个图层的概念类似于 PS 中的图层的概念，这些图层叠加在一起构成了最终的页面图像。

### 节点与图层

通常情况下，并不是布局树的每个节点都有一个专属的图层，如果一个节点没有专属的图层，那么这个节点就从属于父节点的图层。但不管怎样，最终每一个节点都会直接或间接从属于一个层。

当满足下面其中的条件的元素，可以被提升为单独的一个图层：

1. 拥有层叠上下文属性的元素会被提升为单独的一层。
2. 需要剪裁的地方也会被创建一个图层。

#### 裁剪

这里需要了解一下什么是裁剪。

假设把 div 的大小限定为 200 \* 200 像素，而 div 里面的文字内容比较多，文字所显示的区域肯定会超出 200 \* 200 的面积，这时候就产生了剪裁，渲染引擎会把裁剪文字内容的一部分用于显示在 div 区域。出现这种裁剪情况的时候，渲染引擎会为文字部分单独创建一个层，如果出现滚动条，滚动条也会被提升为单独的层。

## 图层绘制

在完成图层数的构建之后，渲染引擎会对图层

## 参考资料

- [浏览器工作原理与实践 - 06 | 渲染流程（下）：HTML、CSS 和 JavaScript，是如何变成页面的？](https://time.geekbang.org/column/article/118826)
