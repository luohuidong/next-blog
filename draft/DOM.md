---
title: "渲染流程 —— 构建 DOM 树"
tag: ["DOM 树", "渲染流程"]
---

渲染流水线中，后面的步骤都直接或者间接地依赖于 DOM 结构。DOM 结构如此的重要，因此这篇文章将介绍 DOM 树是如何生成的。

## 什么是 DOM

从网络进程中获取的 HTML 文件字节流，渲染引擎是无法直接理解的，因此要将其转化为渲染引擎能够理解的结构，即 DOM。DOM 提供了对 HTML 文档结构化的表述。

在渲染引擎中，DOM 有三个层面的作用：

- 从页面的视角来看，DOM 是生成页面的基础数据结构。
- 从 JavaScript 脚本视角来看，DOM 提供给 JavaScript 脚本操作的接口，通过这套接口，JavaScript 可以对 DOM 结构进行访问，从而改变文档的结构、样式和内容。
- 从安全视角来看，DOM 是一道安全防护线，一些不安全的内容在 DOM 解析阶段就被拒之门外了。

简言之，DOM 是表述 HTML 的内部数据结构，它会将 Web 页面和 JavaScript 脚本连接起来，并过滤一些不安全的内容。

## HTML 解析器

在了解 DOM 树的构建之前，需要先了解 HTML 解析器。

在渲染引擎内部，有一个叫 HTML 解析器（HTMLParser）的模块，它的职责就是负责将 HTML 字节流转换为 DOM 结构。

HTML 解析器并不是等待整个 HTML 文档加载完成之后才开始解析的，而是网络进程加载了多少数据，HTML 解析器便解析多少数据。

它的具体流程：

1. 网络进程接收到响应头之后，会根据响应头中的 content-type 字段来判断文件的类型。如果 content-type 的值是 text/html，那么浏览器就会判断这是一个 HTML 类型的文件，然后为该请求选择或者创建一个渲染进程。
2. 渲染进程准备好之后，网络进程和渲染进程之间会建立一个共享数据的管道。
3. 网络进程接收到数据之后就通过管道传送数据给渲染进程，渲染进程接收到数据后会将数据交给 HTML 解析器。网络进程接收到的字节流就像水一样倒进管道，而管道的另一端是渲染进程的 HTML 解析器，它会动态接收字节流，并将其解析为 DOM。

## DOM 的构建

字节流转换为 DOM 需要经历以下阶段：

1. 通过分词器将字节流转换为 Token。
2. 将 Token 解析为 DOM 节点，并将 DOM 节点添加到 DOM 树中。

## 参考资料

- [重学前端 —— 浏览器：一个浏览器是如何工作的？（阶段二）](https://time.geekbang.org/column/article/80260)
- [浏览器工作原理与实践 —— 22 | DOM 树：JavaScript 是如何影响 DOM 树构建的？](https://time.geekbang.org/column/article/140140)
